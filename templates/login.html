{% extends "base.html" %}

{% block title %}Sign In - Smart Attendance System{% endblock %}

{% block extra_styles %}
<style>
    :root{
      --bg-blur: 18px;
      --bg-dim: rgba(4,6,11,0.55);
      --transition-fast: 220ms;
      --transition-medium: 400ms;
    }

    body { margin: 0; padding: 0; }
    .login-container {
        min-height: 100vh;
        display: flex;
        position: relative;
        overflow: hidden;
        background: #0a1929;
    }

    .bg-layer {
        position: absolute;
        inset: 0;
        z-index: 0; 
        overflow: hidden;
    }
    .bg-slide {
        position: absolute;
        inset: -10%;
        background-size: cover;
        background-position: center;
        filter: blur(var(--bg-blur)) saturate(1.05);
        transform: scale(1.06);
        opacity: 1;
        transition: opacity var(--transition-medium) ease, transform var(--transition-medium) ease, filter var(--transition-medium) ease;
        will-change: transform, filter, opacity;
    }
    .bg-slide.hidden { opacity: 0; pointer-events: none; }

    /* dim overlay for contrast */
    .bg-dim {
        position: absolute; inset: 0; background: linear-gradient(180deg, rgba(10,19,41,0.18), rgba(4,6,11,0.6));
        z-index: 1;
    }

    .login-left {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        position: relative;
        z-index: 2; /* above bg */
        background: linear-gradient(135deg, rgba(30,58,138,0.08) 0%, rgba(15,23,42,0.08) 100%); /* subtle */
    }
    .login-right {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        background: rgba(10,25,41,0.05);
        z-index: 2;
    }

    .face-image {
        max-width: 100%;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        transform: translateZ(0);
        transition: transform var(--transition-fast) ease, box-shadow var(--transition-fast) ease, filter var(--transition-fast) ease;
        cursor: pointer;
        display: block;
    }
    .face-image:hover,
    .face-image:focus {
        transform: translateY(-8px) scale(1.035);
        box-shadow: 0 28px 80px rgba(2,6,23,0.6);
        filter: saturate(1.05);
    }

    .signin-form { width: 100%; max-width: 400px; }
    .form-title { color: #fff; font-size: 2rem; font-weight: 600; margin-bottom: 2rem; }
    .form-label { color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.5rem; display: block; }
    .form-input {
        width: 100%; padding: 0.875rem 1rem; background: #1e293b; border: 1px solid #334155;
        border-radius: 8px; color: #fff; font-size: 0.9375rem; transition: all var(--transition-fast);
        margin-bottom: 1.25rem;
    }
    .form-input:focus { outline: none; border-color: #3b82f6; background: #0f172a; }
    .form-input::placeholder { color: #64748b; }
    .btn-signin {
        width: 100%; padding: 0.875rem; background: #3b82f6; color: #fff; border: none; border-radius: 8px;
        font-size: 1rem; font-weight: 600; cursor: pointer; transition: all var(--transition-fast);
        margin-top: 0.5rem;
    }
    .btn-signin:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(59,130,246,0.2); }

    .signup-link { text-align: center; margin-top: 1.5rem; color: #94a3b8; }
    .signup-link a { color: #3b82f6; text-decoration: none; font-weight: 600; }
    .signup-link a:hover { text-decoration: underline; }

    .app-title { color: #f7f4f4; font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; letter-spacing: 0.5px; }

    .bg-thumbs {
        position: absolute;
        left: 1.25rem;
        bottom: 1.25rem;
        z-index: 3;
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .bg-thumb {
        width: 64px; height: 40px; border-radius: 8px; overflow: hidden; border: 2px solid rgba(255,255,255,0.06);
        box-shadow: 0 6px 18px rgba(2,6,23,0.45); background-size: cover; background-position: center;
        transform: translateZ(0);
        transition: transform var(--transition-fast) ease, box-shadow var(--transition-fast) ease, border-color var(--transition-fast);
        cursor: pointer;
    }
    .bg-thumb:hover, .bg-thumb:focus { transform: translateY(-6px) scale(1.06); border-color: rgba(255,255,255,0.18); box-shadow: 0 18px 46px rgba(2,6,23,0.6); }
    .bg-thumb.active { outline: 3px solid rgba(59,130,246,0.16); border-color: rgba(59,130,246,0.3); }

    /* responsive tweaks */
    @media (max-width: 1024px) {
      .bg-thumb { width: 56px; height: 36px; }
    }
    @media (max-width: 768px) {
        .login-container { flex-direction: column; }
        .login-left { display: none; } 
        .login-right { flex: 1; }
        .bg-thumbs { display: none; }
    }

    @media (prefers-reduced-motion: reduce) {
        .bg-slide, .face-image, .bg-thumb, .btn-signin { transition: none !important; transform: none !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="login-container">
    <div class="bg-layer" aria-hidden="true">
        <div class="bg-slide" id="bg-0" style="background-image: url('/static/assets/scan.jpg');"></div>
        <div class="bg-slide hidden" id="bg-1" style="background-image: url('/static/assets/homePage2.png');"></div>
        <div class="bg-slide hidden" id="bg-2" style="background-image: url('/static/assets/homePage4.jpeg');"></div>
        <div class="bg-dim"></div>
    </div>

    <!-- Left column (visual) -->
    <div class="login-left" aria-hidden="false">
        <div style="max-width: 540px; width:100%; display:flex; flex-direction:column; gap:1rem; align-items:center;">
            <img src="/static/assets/home-page.jpg"
                 alt="Face Recognition"
                 class="face-image"
                 id="mainFaceImage"
                 tabindex="0"
                 />
        </div>

        <!-- thumbnails to switch background  -->
        <div class="bg-thumbs" id="bgThumbs" aria-label="Choose background image">
            <div class="bg-thumb" data-index="0" style="background-image:url('/static/assets/scan.jpg');" title="Background 1"></div>
            <div class="bg-thumb" data-index="1" style="background-image:url('/static/assets/homePage2.png');" title="Background 2"></div>
            <div class="bg-thumb" data-index="2" style="background-image:url('/static/assets/homePage4.jpeg');" title="Background 3"></div>
        </div>
    </div>

    <!-- Right column (form) -->
    <div class="login-right">
        <div class="signin-form" role="form" aria-labelledby="signinTitle">
            <div class="app-title"><h1>Smart Attendance System</h1></div>
            <h1 id="signinTitle" class="form-title">Sign in</h1>

            <form id="loginForm" autocomplete="on">
                <div>
                    <label class="form-label" for="email">Email</label>
                    <input type="email" id="email" name="email" required class="form-input" placeholder="you@company.com" autocomplete="email">
                </div>

                <div>
                    <label class="form-label" for="password">Password</label>
                    <input type="password" id="password" name="password" required class="form-input" placeholder="Your password" autocomplete="current-password">
                </div>

                <button type="submit" class="btn-signin">Sign in</button>
            </form>

            <div class="signup-link">
                Don't have an account? <a href="/register">Request Enrollment from Admin</a>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
  const homeBackgroundImages = [
    '/static/assets/homePage2.png',
    '/static/assets/homePage4.jpeg',
    '/static/assets/scan.jpg'

  ];

  const slides = [];
  for (let i=0;i<homeBackgroundImages.length;i++){
    let el = document.getElementById('bg-'+i);
    if(!el){
      el = document.createElement('div');
      el.className = 'bg-slide';
      el.id = 'bg-'+i;
      el.style.backgroundImage = `url("${homeBackgroundImages[i]}")`;
      const layer = document.querySelector('.bg-layer');
      if(layer) layer.insertBefore(el, layer.firstChild);
    } else {
      el.style.backgroundImage = `url("${homeBackgroundImages[i]}")`;
    }
    slides.push(el);
  }

  let idx = 0;
  slides.forEach((s,i)=> {
    s.classList.toggle('hidden', i !== 0);
    if(!s.classList.contains('hidden')) idx = i;
  });

  // Thumbnails control
  const thumbsContainer = document.getElementById('bgThumbs');
  thumbsContainer.innerHTML = ''; // clear fallback thumbs
  homeBackgroundImages.forEach((src, i) => {
      const thumb = document.createElement('button');
      thumb.className = 'bg-thumb';
      thumb.setAttribute('aria-label', `Set background ${i+1}`);
      thumb.style.backgroundImage = `url('${src}')`;
      thumb.dataset.index = i;
      thumb.type = 'button';
      if(i===0) thumb.classList.add('active');

      // click to switch background
      thumb.addEventListener('click', () => {
        setBackground(i);
      });
      // keyboard accessible
      thumb.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setBackground(i); }
      });

      thumbsContainer.appendChild(thumb);
  });

  function setBackground(newIndex){
    if(newIndex === idx) return;
    slides.forEach((s,i)=>{
      if(i === newIndex){
        s.classList.remove('hidden');
        s.style.opacity = '1';
        s.style.filter = 'blur(var(--bg-blur)) saturate(1.05)';
        s.style.transform = 'scale(1.06)';
      } else {
        s.classList.add('hidden');
      }
    });
    document.querySelectorAll('.bg-thumb').forEach(t => t.classList.toggle('active', parseInt(t.dataset.index)===newIndex));
    idx = newIndex;
  }

  const mainFace = document.getElementById('mainFaceImage');
  const bgLayer = document.querySelector('.bg-layer');

  function onFaceHover() {
    slides.forEach((s) => {
      s.style.filter = 'blur(calc(var(--bg-blur) - 15px)) saturate(1.02)';
      s.style.transform = 'scale(1.02)';
    });
  }
  function onFaceLeave() {
    slides.forEach((s) => {
      s.style.filter = 'blur(var(--bg-blur)) saturate(1.05)';
      s.style.transform = 'scale(1.09)';
    });
  }

  if (mainFace) {
    mainFace.addEventListener('mouseenter', onFaceHover);
    mainFace.addEventListener('focus', onFaceHover);
    mainFace.addEventListener('mouseleave', onFaceLeave);
    mainFace.addEventListener('blur', onFaceLeave);
  }

  const autoRotate = false;
  const rotateIntervalMs = 8000;
  if(autoRotate && homeBackgroundImages.length > 1){
    setInterval(()=> {
      const next = (idx + 1) % homeBackgroundImages.length;
      setBackground(next);
    }, rotateIntervalMs);
  }

  window.setLoginBackgrounds = function(imageArray){
    if(!Array.isArray(imageArray) || imageArray.length === 0) return;
    homeBackgroundImages.length = 0;
    imageArray.forEach(u => homeBackgroundImages.push(u));
    location.reload(); 
  };

})();

// Login form handler
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Signing in...';
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        showToast('Please enter both email and password', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        return;
    }
    
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            setToken(data.access_token);
            setUserData(data.user);
            showToast('Login successful!', 'success');
            
            // Redirect based on user type
            setTimeout(() => {
                if (data.user_type === 'superadmin') {
                    window.location.href = '/superadmin/dashboard';
                } else if (data.user_type === 'admin') {
                    window.location.href = '/admin/dashboard';
                } else {
                    window.location.href = '/user/dashboard';
                }
            }, 500);
        } else {
            showToast(data.error || 'Login failed. Please check your credentials.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    } catch (error) {
        console.error('Login error:', error);
        showToast('Connection error. Please check your internet and try again.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});
</script>
{% endblock %}
