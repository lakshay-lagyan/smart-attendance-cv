{% extends "base.html" %}

{% block title %}Enrollment Requests - Admin{% endblock %}

{% block extra_styles %}
<style>
    .sidebar { transition: transform 0.3s ease; }
    @media (max-width: 768px) {
        .sidebar.hidden-mobile { transform: translateX(-100%); }
    }
    .modal { display: none; }
    .modal.active { display: flex; }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    <div id="sidebar" class="sidebar fixed md:static w-64 bg-gradient-to-b from-blue-600 to-blue-900 text-white h-full z-50">
        <div class="p-6 border-b border-blue-500">
            <h1 class="text-2xl font-bold">Admin Panel</h1>
        </div>
        
        <nav class="p-4">
            <a href="/admin/dashboard" class="flex items-center p-3 mb-2 hover:bg-blue-700 rounded-lg">
                <i class="fas fa-dashboard mr-3"></i> Dashboard
            </a>
            <a href="/admin/enrollment" class="flex items-center p-3 mb-2 hover:bg-blue-700 rounded-lg">
                <i class="fas fa-user-plus mr-3"></i> Enroll Person
            </a>
            <a href="/admin/requests" class="flex items-center p-3 mb-2 bg-blue-700 rounded-lg">
                <i class="fas fa-inbox mr-3"></i> Requests
            </a>
            <button onclick="logout()" class="w-full flex items-center p-3 mt-4 hover:bg-red-600 rounded-lg">
                <i class="fas fa-sign-out-alt mr-3"></i> Logout
            </button>
        </nav>
    </div>
    
    <div class="flex-1 overflow-auto">
        <div class="bg-white shadow-sm p-4 flex justify-between items-center">
            <button id="menuToggle" class="md:hidden text-gray-600">
                <i class="fas fa-bars text-2xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-gray-800">Enrollment Requests</h2>
        </div>
        
        <div class="p-4 md:p-6">
            <div class="bg-white rounded-lg shadow">
                <div id="requestsList" class="divide-y">
                    <div class="p-8 text-center text-gray-500">Loading requests...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Request Modal -->
<div id="viewModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-2xl font-bold">Request Details</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <div id="modalContent" class="p-6"></div>
    </div>
</div>

<script>
let currentRequests = [];

document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    
    menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('hidden-mobile');
    });
    
    loadRequests();
});

async function loadRequests() {
    try {
        const response = await apiRequest('/admin/enrollment/requests?status=pending');
        const data = await response.json();
        
        if (response.ok) {
            currentRequests = data.requests;
            displayRequests(data.requests);
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to load requests', 'error');
    }
}

function displayRequests(requests) {
    const listDiv = document.getElementById('requestsList');
    
    if (requests.length === 0) {
        listDiv.innerHTML = '<div class="p-8 text-center text-gray-500">No pending requests</div>';
        return;
    }
    
    listDiv.innerHTML = requests.map((req, index) => `
        <div class="p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div class="mb-4 md:mb-0">
                    <h4 class="text-lg font-bold">${req.name}</h4>
                    <p class="text-gray-600">${req.email}</p>
                    <p class="text-sm text-gray-500">Submitted: ${new Date(req.submitted_at).toLocaleString()}</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="viewRequest(${index})" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-eye mr-2"></i> View
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function viewRequest(index) {
    const req = currentRequests[index];
    const modal = document.getElementById('viewModal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = `
        <div class="space-y-4">
            <div>
                <h4 class="font-semibold mb-2">Personal Information</h4>
                <p><strong>Name:</strong> ${req.name}</p>
                <p><strong>Email:</strong> ${req.email}</p>
                <p><strong>Phone:</strong> ${req.phone || 'N/A'}</p>
            </div>
            
            <div>
                <h4 class="font-semibold mb-2">Submitted Photos</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    ${req.images.map(img => `
                        <img src="${img}" class="w-full h-auto rounded border">
                    `).join('')}
                </div>
            </div>
            
            <div class="flex space-x-4 pt-4">
                <button onclick="approveRequest(${req.id})" 
                    class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold">
                    <i class="fas fa-check mr-2"></i> Approve
                </button>
                <button onclick="showRejectForm(${req.id})" 
                    class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-semibold">
                    <i class="fas fa-times mr-2"></i> Reject
                </button>
            </div>
            
            <div id="rejectForm" class="hidden pt-4">
                <label class="block font-semibold mb-2">Rejection Reason:</label>
                <textarea id="rejectReason" class="w-full border rounded-lg p-3 mb-4" rows="3"></textarea>
                <div class="flex space-x-4">
                    <button onclick="confirmReject(${req.id})" class="flex-1 bg-red-500 text-white py-2 rounded hover:bg-red-600">
                        Confirm Reject
                    </button>
                    <button onclick="cancelReject()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeModal() {
    document.getElementById('viewModal').classList.remove('active');
}

async function approveRequest(id) {
    try {
        const response = await apiRequest(`/admin/enrollment/requests/${id}/approve`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Request approved successfully!', 'success');
            closeModal();
            loadRequests();
        } else {
            showToast(data.error || 'Approval failed', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Approval failed', 'error');
    }
}

function showRejectForm(id) {
    document.getElementById('rejectForm').classList.remove('hidden');
}

function cancelReject() {
    document.getElementById('rejectForm').classList.add('hidden');
    document.getElementById('rejectReason').value = '';
}

async function confirmReject(id) {
    const reason = document.getElementById('rejectReason').value.trim();
    
    if (!reason) {
        showToast('Please provide a rejection reason', 'error');
        return;
    }
    
    try {
        const response = await apiRequest(`/admin/enrollment/requests/${id}/reject`, {
            method: 'POST',
            body: JSON.stringify({ reason })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Request rejected', 'success');
            closeModal();
            loadRequests();
        } else {
            showToast(data.error || 'Rejection failed', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Rejection failed', 'error');
    }
}
</script>
{% endblock %}
